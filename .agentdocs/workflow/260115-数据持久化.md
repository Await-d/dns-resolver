# 数据持久化实现

## 任务概述

将后端的内存存储（InMemory）改为真实的数据持久化存储，确保应用重启后数据不丢失。

## 当前分析

### 现有内存存储

| 仓储 | 文件 | 数据类型 | 问题 |
|------|------|----------|------|
| `InMemoryUserRepository` | 用户数据 | 用户账号、密码 | 重启丢失 |
| `InMemoryDdnsTaskRepository` | DDNS 任务 | 动态域名任务配置 | 重启丢失 |
| `InMemoryIspProviderRepository` | ISP 配置 | 从配置文件读取 | ✅ 无需修改 |

### 真实数据部分（无需修改）

- **DNS 解析**: 使用 `DnsClient` 库进行真实网络查询
- **公网 IP 获取**: 使用 `ipify.org` 等真实 API
- **ISP 配置**: 从 `appsettings.json` 读取

## 解决方案

采用 **SQLite + Entity Framework Core** 方案：
- 轻量级，无需额外数据库服务
- 单文件存储，便于部署和备份
- EF Core 提供完整的 ORM 支持

## 实现计划

### 阶段 1：添加 EF Core 依赖
- [x] T-01: 添加 EF Core SQLite NuGet 包到 Infrastructure 项目

### 阶段 2：创建数据库上下文
- [x] T-02: 创建 AppDbContext 数据库上下文
- [x] T-03: 配置 User 实体映射
- [x] T-04: 配置 DdnsTask 实体映射

### 阶段 3：实现持久化仓储
- [x] T-05: 实现 EfUserRepository 替换 InMemoryUserRepository
- [x] T-06: 实现 EfDdnsTaskRepository 替换 InMemoryDdnsTaskRepository

### 阶段 4：数据库初始化
- [x] T-07: 添加数据库迁移和初始化逻辑
- [x] T-08: 实现默认管理员账号初始化（首次启动时）

### 阶段 5：配置和注册
- [x] T-09: 更新 Program.cs 注册 EF Core 服务
- [x] T-10: 添加数据库连接字符串配置

### 阶段 6：测试验证
- [x] T-11: 验证用户登录和密码修改持久化
- [x] T-12: 验证 DDNS 任务 CRUD 持久化

## 完成状态

✅ 所有任务已完成

## 技术要点

- SQLite 数据库文件位置: `data/dns-resolver.db`
- 使用 Code First 方式管理数据库结构
- 首次启动自动创建数据库和默认管理员
- 保持与现有接口兼容，只替换实现

## 文件变更清单

**新增文件:**
- `Infrastructure/Data/AppDbContext.cs`
- `Infrastructure/Data/Configurations/UserConfiguration.cs`
- `Infrastructure/Data/Configurations/DdnsTaskConfiguration.cs`
- `Infrastructure/Repositories/EfUserRepository.cs`
- `Infrastructure/Repositories/EfDdnsTaskRepository.cs`

**修改文件:**
- `Infrastructure/DnsResolver.Infrastructure.csproj` - 添加 EF Core 包
- `Api/Program.cs` - 注册 EF Core 服务
- `Api/appsettings.json` - 添加连接字符串
