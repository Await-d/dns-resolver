# 后端 DDD 架构重构方案

## 任务概述

将当前简单分层架构重构为 DDD（领域驱动设计）架构。

**状态**: ✅ 已完成

---

## 最终架构

```
backend/src/
├── DnsResolver.Domain/              # 领域层 (核心，无外部依赖)
│   ├── Aggregates/
│   │   ├── DnsQuery/
│   │   │   ├── DnsQuery.cs
│   │   │   └── ResolveResult.cs
│   │   └── IspProvider/
│   │       ├── IspProvider.cs
│   │       └── IIspProviderRepository.cs
│   ├── ValueObjects/
│   │   ├── DomainName.cs
│   │   ├── DnsServer.cs
│   │   ├── DnsRecord.cs
│   │   └── RecordType.cs
│   ├── Services/
│   │   └── IDnsResolutionService.cs
│   └── Exceptions/
│       ├── DomainException.cs
│       ├── InvalidDomainException.cs
│       └── DnsResolutionException.cs
│
├── DnsResolver.Application/         # 应用层
│   ├── Commands/
│   │   ├── ResolveDns/
│   │   │   ├── ResolveDnsCommand.cs
│   │   │   ├── ResolveDnsResult.cs
│   │   │   └── ResolveDnsCommandHandler.cs
│   │   └── CompareDns/
│   │       ├── CompareDnsCommand.cs
│   │       ├── CompareDnsResult.cs
│   │       └── CompareDnsCommandHandler.cs
│   ├── Queries/
│   │   └── GetIsps/
│   │       ├── GetIspsQuery.cs
│   │       └── GetIspsQueryHandler.cs
│   ├── DTOs/
│   │   ├── DnsRecordDto.cs
│   │   └── IspProviderDto.cs
│   └── Interfaces/
│
├── DnsResolver.Infrastructure/      # 基础设施层
│   ├── DnsClient/
│   │   └── DnsClientAdapter.cs
│   ├── Repositories/
│   │   └── InMemoryIspProviderRepository.cs
│   └── Configuration/
│       └── DnsSettings.cs
│
└── DnsResolver.Api/                 # 表现层
    ├── Controllers/
    │   └── DnsController.cs
    ├── Requests/
    │   ├── ResolveRequest.cs
    │   └── CompareRequest.cs
    ├── Responses/
    │   └── ApiResponse.cs
    ├── Middleware/
    │   └── ExceptionMiddleware.cs
    └── Program.cs
```

---

## 实施计划

### Phase 1: 创建项目结构
- [x] T-01: 创建 DnsResolver.Domain 项目 ✅
- [x] T-02: 创建 DnsResolver.Application 项目 ✅
- [x] T-03: 创建 DnsResolver.Infrastructure 项目 ✅
- [x] T-04: 重命名 DnsResolver.Web 为 DnsResolver.Api ✅

### Phase 2: 实现领域层
- [x] T-05: 实现值对象 (DomainName, RecordType, DnsServer, DnsRecord) ✅
- [x] T-06: 实现聚合根 (DnsQuery, IspProvider) ✅
- [x] T-07: 定义仓储接口 (IIspProviderRepository) ✅
- [x] T-08: 定义领域服务接口 (IDnsResolutionService) ✅

### Phase 3: 实现应用层
- [x] T-09: 实现 Commands 和 Handlers ✅
- [x] T-10: 实现 Queries 和 Handlers ✅
- [x] T-11: 实现 DTOs ✅

### Phase 4: 实现基础设施层
- [x] T-12: 实现 DnsClientAdapter ✅
- [x] T-13: 实现 InMemoryIspProviderRepository ✅
- [x] T-14: 配置 DnsSettings ✅

### Phase 5: 更新表现层
- [x] T-15: 重构 DnsController ✅
- [x] T-16: 更新 DI 配置 ✅
- [x] T-17: 更新异常处理中间件 ✅

### Phase 6: 清理和测试
- [x] T-18: 删除旧的 Core 项目 ✅
- [x] T-19: 验证 API 功能 (Build succeeded) ✅

---

## 依赖关系

```
┌─────────────────┐
│  DnsResolver.Api │  ← 表现层
└────────┬────────┘
         │ 依赖
         ▼
┌─────────────────────────┐
│ DnsResolver.Application │  ← 应用层
└────────┬────────────────┘
         │ 依赖
         ▼
┌──────────────────┐
│ DnsResolver.Domain │  ← 领域层 (核心，无外部依赖)
└──────────────────┘
         ▲
         │ 实现接口
┌────────┴────────────────────┐
│ DnsResolver.Infrastructure │  ← 基础设施层
└─────────────────────────────┘
```

---

## 完成时间

2026-01-14
